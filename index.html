<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Introduction to Variant Calling using Galaxy by khalidm</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Introduction to Variant Calling using Galaxy</h1>
      <h2 class="project-tagline"></h2>
      <a href="https://github.com/khalidm/Intro-variant-calling-galaxy" class="btn">View on GitHub</a>
      <a href="https://github.com/khalidm/Intro-variant-calling-galaxy/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/khalidm/Intro-variant-calling-galaxy/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <p>
<img src="https://github.com/khalidm/Intro-variant-calling-galaxy/raw/master/media/vlsci_logo.jpg" alt="VLSCI logo" align="left" width="164">
<img src="https://github.com/khalidm/Intro-variant-calling-galaxy/raw/master/media/gvl_logo.jpg" alt="GVL logo" align="right" width="112">
</p>

<p><br></p>

<p><br></p>

<h1>
<a id="table-of-contents" class="anchor" href="#table-of-contents" aria-hidden="true"><span class="octicon octicon-link"></span></a>Table of Contents</h1>

<ol>
<li><a href="#1-tutorial-overview">Tutorial Overview</a></li>
<li><a href="#2-background">Background</a></li>
<li><a href="#3-preparation">Preparation</a></li>
<li><a href="#4-quality-control">Quality Control</a></li>
<li>
<a href="#5-alignment-to-the-reference---fastq-to-bam">Alignment to the reference - (FASTQ to BAM)</a>)</li>
<li><a href="#6-calling-single-nucleotide-variations-snvs">Calling single nucleotide variations(SNVs)</a></li>
<li><a href="#7-calling-small-insertions-and-deletions-indels">Calling small insertions and deletetions</a></li>
</ol>

<h2>
<a id="1-tutorial-overview" class="anchor" href="#1-tutorial-overview" aria-hidden="true"><span class="octicon octicon-link"></span></a>1. Tutorial Overview</h2>

<p>In this tutorial we cover the concepts of detecting small variants (SNVs and indels) in human genomic DNA using a small set of reads from chromosome 22.</p>

<p>Note:</p>

<p>The tutorial is designed to introduce the tools, datatypes and workflow of variation detection. We filter the variations manually to understand what is actually happening in variant calling. In practice the datasets would be much larger and you would use more sophisticated tools to call, annotate and filter variants.</p>

<h2>
<a id="2-background" class="anchor" href="#2-background" aria-hidden="true"><span class="octicon octicon-link"></span></a>2. Background</h2>

<p>Some background reading material - <a href="https://www.google.com/url?q=https://docs.google.com/document/pub?id%3D1NfythYcSrkQwldGMrbHRKLRORFFn-WnBm3gOMHwIgmE&amp;sa=D&amp;usg=AFQjCNE7C6wmK6Fiu-_ZJhc0RSBaxFSRbg">background</a></p>

<h4>
<a id="where-is-the-data-in-this-tutorial-from" class="anchor" href="#where-is-the-data-in-this-tutorial-from" aria-hidden="true"><span class="octicon octicon-link"></span></a>Where is the data in this tutorial from?</h4>

<p>The workshop is based on analysis of short read data from the exome of chromosome 22 of a single human individual. There are one million 76bp reads in the dataset, produced on an Illumina GAIIx from exome-enriched DNA. This data was generated as part of the <a href="http://www.1000genomes.org/">1000 genomes</a> Genomes project.</p>

<h2>
<a id="3-preparation" class="anchor" href="#3-preparation" aria-hidden="true"><span class="octicon octicon-link"></span></a>3. Preparation</h2>

<ol>
<li>
<strong>Make sure you have an instance of Galaxy ready to go.</strong>

<ul>
<li> If not - go to our <a href="http://galaxy-mel.genome.edu.au/galaxy">Melbourne Galaxy</a> instance.</li>
</ul>
</li>
<li>
<strong>Import data for the workshop.</strong>

<ul>
<li>Download the data to your local computer. <a href="https://www.google.com/url?q=https://swift.rc.nectar.org.au:8888/v1/AUTH_a3929895f9e94089ad042c9900e1ee82/VariantDet_BASIC/NA12878.GAIIx.exome_chr22.1E6reads.76bp.fastq&amp;sa=D&amp;usg=AFQjCNFuof3Ud3BzcKkW54yL-1ySLIXPNg">FASTQ file</a>
</li>
<li>This is the raw <a href="https://en.wikipedia.org/wiki/FASTQ_format">FASTQ</a> file.</li>
</ul>
</li>
<li>
<strong>Upload data to Galaxy.</strong>

<ul>
<li>In the Galaxy tools panel (left), click on <em>Get Data</em> and choose <em>Upload File</em>.</li>
<li>From <em>Choose local file</em> select the downloaded FASTQ file. Select <em>Type</em> as <strong>fastqsanger</strong> and click <em>Start</em>.</li>
<li>Once the upload status turns <em>green</em>, it means the upload is complete. You should now be able to see the file in the Galaxy history panel (right).</li>
</ul>
</li>
</ol>

<pre><code>
Summary:
So far, we have started a Galaxy instance, got hold of our data and uploaded it to
the Galaxy instance.
Now we are ready to perform our analysis.

</code></pre>

<h2>
<a id="4-quality-control" class="anchor" href="#4-quality-control" aria-hidden="true"><span class="octicon octicon-link"></span></a>4. Quality Control</h2>

<p>The first step is to evaluate the quality of the raw sequence data. If the quality is poor, then adjustments can be made - e.g. trimming the short reads, or adjusting your expectations of the final outcome!</p>

<h4>
<a id="take-a-look-at-a-fastq-file" class="anchor" href="#take-a-look-at-a-fastq-file" aria-hidden="true"><span class="octicon octicon-link"></span></a>Take a look at a FASTQ file</h4>

<ol>
<li>Click on the eye icon to the top right of the fastq file to view the a snippet of the file.</li>
<li>Note that each read is represented by 4 lines:

<ul>
<li>read identifier</li>
<li>short read sequence</li>
<li>separator</li>
<li>short read sequence quality scores</li>
</ul>
</li>
</ol>

<pre><code>
e.g.
identifier:    @61CC3AAXX100125:7:72:14903:20386/1
read sequence: TTCCTCCTGAGGCCCCACCCACTATACATCATCCCTTCATGGTGAGGGAGACTTCAGCCCTCAATGCCACCTTCAT
separator:     +
quality score: ?ACDDEFFHBCHHHHHFHGGCHHDFDIFFIFFIIIIHIGFIIFIEEIIEFEIIHIGFIIIIIGHCIIIFIID?@&lt;6

</code></pre>

<p>For more details see <a href="https://en.wikipedia.org/wiki/FASTQ_format">FASTQ</a>.</p>

<h4>
<a id="assessing-read-quality-from-the-fastq-files" class="anchor" href="#assessing-read-quality-from-the-fastq-files" aria-hidden="true"><span class="octicon octicon-link"></span></a>Assessing read quality from the FASTQ files</h4>

<p>From the Galaxy tools panel, select</p>

<pre><code>
NGS: QC and manipulation &gt; FastQC: Comprehensive QC

The input FASTQ file will be selected by default. Keep the other defaults and click 'Execute'

</code></pre>

<p>Note the batch processing interface of Galaxy:</p>

<p>grey = waiting in queue
yellow = running
green = finished
red = tried to run and failed</p>

<p>Wait for job to be complete.</p>

<p>Click on the eye icon to view the newly generated data (in this case a set of quality metrics for the FASTQ data).
Look at the various quality scores. The data looks pretty good - <em>high Per base sequence quality</em> (avg. above 30).</p>

<p><em>Note that the 'Sequence Duplication Levels' are marked as high. Normally we would run another tool to remove duplicates (technical PCR artifacts) but for the sake of brevity we will omit this step.</em></p>

<h2>
<a id="5-alignment-to-the-reference---fastq-to-bam" class="anchor" href="#5-alignment-to-the-reference---fastq-to-bam" aria-hidden="true"><span class="octicon octicon-link"></span></a>5. Alignment to the reference - (FASTQ to BAM)</h2>

<p>The basic process here to map individual reads - from the input sample FASTQ file - to a matching region on the reference genome.</p>

<ol>
<li>
<p>Map/align the reads with the <a href="http://bio-bwa.sourceforge.net/">BWA</a> tool to Human reference genome 19 (hg19) <a href="http://genome.ucsc.edu/cgi-bin/hgTracks">UCSC hg19</a>.
From the Galaxy tools panel, select</p>

<pre><code>NGS: Mapping &gt; Map with BWA-MEM [3-5mins]

From the options:
Using reference genome: set to hg19.
Single or Paired-end reads: set to Single

keep other options as default and click execute
</code></pre>

<p><em>Note: This is the longest step in the workshop and will take a few minutes, possibly more depending on how many people are also scheduling mappings</em></p>
</li>
<li>
<p>Sort the BAM file.
From the Galaxy tools panel, select</p>

<pre><code>NGS: SAM Tools &gt; Sort BAM dataset

From the options:
BAM File: set to the output from the alignment BAM file
Sort by: Chromosomal coordinates

Keep other options as default and click execute
</code></pre>
</li>
<li>
<p>To examine the output sorted BAM file, we need to first convert it into readable <a href="https://samtools.github.io/hts-specs/SAMv1.pdf">SAM</a> format.
From the Galaxy tools panel, select</p>

<pre><code>NGS: SAM Tools &gt; BAM-to-SAM

From the options:
BAM File to Convert: set to the output to the sorted BAM file

Keep other options as default and click execute
</code></pre>
</li>
<li>
<p>Examine the generated Sequence Alignment Map (SAM) file.</p>

<ul>
<li>Click the eye icon next to the newly generated file</li>
<li>Familiarise yourself with the <a href="https://samtools.github.io/hts-specs/SAMv1.pdf">SAM</a> format</li>
<li>
<p>Note that some reads have mapped to non-chr22 chromosomes (see column 3).</p>

<p>This is the essence of alignment algorithms - the aligner does the best it can, but because of compromises in accuracy vs performance and repetitive sequences in the genome, not all the reads will necessarily align to the ‘correct’ sequence or could this be suggesting the presence of a structural variant?</p>
</li>
</ul>

<blockquote>
<p><img src="https://github.com/khalidm/Intro-variant-calling-galaxy/raw/master/media/tips.png" alt="Tip" height="42" width="42">
Tip:
Galaxy auto-generates a name for all outputs. Therefore, it is advisable to choose a more meaningful name to these outputs.
This can be done as follow:
Click on the pencil icon (edit attributes) and change Name e.g. Sample.bam or Sample.sam or Sample.sorted.bam etc.</p>
</blockquote>
</li>
<li>
<p>Assessing the alignment data</p>

<p><em>Histogram of genome coverage</em>
From the Galaxy tools panel, select</p>

<pre><code>BED tools &gt; Create a histogram of genome coverage

From the options:
The BAM: select the sorted BAM file

keep other options as default and click execute      
</code></pre>

<p>The output format:
Output (tab delimited):</p>

<ol>
<li>chromosome (or entire genome)</li>
<li>depth of coverage from features in input file</li>
<li>number of bases on chromosome (or genome) with depth equal to column 2</li>
<li>size of chromosome (or entire genome) in base pairs</li>
<li>fraction of bases on chromosome (or entire genome) with depth equal to column 2</li>
</ol>

<p><em>Mapping statistics</em>
From the Galaxy tools panel, select</p>

<pre><code>NGS: SAM Tools &gt; IdxStats

From the options:
The BAM: select the sorted BAM file

keep other options as default and click execute  
</code></pre>

<p>The output format:
Output (tab delimited):</p>

<ol>
<li>reference sequence identifier (chromosome)</li>
<li>reference sequence length</li>
<li>number of mapped reads</li>
<li>number of placed but unmapped reads<br>
</li>
</ol>

<p><em>Check the number of aligned and unaligned reads + other quality metrics</em>
From the Galaxy tools panel, select</p>

<pre><code>
NGS: Sam Tools &gt; Flagstat

From the options:
The BAM: select the sorted BAM file

keep other options as default and click execute

</code></pre>

<p>Note that in this case the statistics are not very informative. This is because the dataset has been generated for this workshop and much of the noise has been removed (and in fact we just removed a lot more noise in the previous step); also we are using single ended read data rather than paired-end so some of the metrics are not relevant.</p>
</li>
<li>
<p>Visualize the BAM file.</p>

<ul>
<li>Download the sorted BAM file
From the Galaxy history panel, select</li>
</ul>

<pre><code>
Click on the sorted BAM file.
Click on the disk icon &gt; Download dataset
Click on the disk icon &gt; Download bam_index

Result:
This will result in two files being downloaded 1) bam file 2) bam index file

Open [IGV] browser &gt; Open downloaded BAM file &gt; select chromosome 22

Can't see anything!

Zoom in further or type a gene of interest and now you should see aligned reads.

</code></pre>

<p><img src="https://github.com/khalidm/Intro-variant-calling-galaxy/raw/master/media/igv1.jpg" alt="IGV view 1" width="640px"></p>

<pre><code>
Try looking at region chr22:36,006,744-36,007,406
Can you see a few variants?  

</code></pre>

<p><img src="https://github.com/khalidm/Intro-variant-calling-galaxy/raw/master/media/igv_mb.jpg" alt="IGV view 1" width="640px"></p>
</li>
</ol>

<h2>
<a id="6-calling-single-nucleotide-variations-snvs" class="anchor" href="#6-calling-single-nucleotide-variations-snvs" aria-hidden="true"><span class="octicon octicon-link"></span></a>6. Calling single nucleotide variations (SNVs)</h2>

<ol>
<li>
<p>Generate a pileup file from the aligned reads (sorted bam file previous step 2). A pileup is essentially a column wise representation of the aligned read - at the base level - to the reference. The pileup file summarises all data from the reads at each genomic region that is covered by at least one read.</p>

<p>From the Galaxy tools panel, select</p>

<pre><code>
NGS: SAMtools&gt;Generate Pileup

From the options:
Call consensus according to MAQ model = Yes
This generates a called 'consensus base' for each chromosomal position.

keep other options as default and click execute  

</code></pre>

<p>For each output file, Galaxy tries to assign a datatype attribute to every file. For each output file, Galaxy tries to assign a datatype attribute to every file.</p>

<pre><code>
Firstly, remember to rename output files to something more meaningful e.g. the workflow stage
For the above output, click on the pencil icon (edit attributes) and choose Datatype link from the top column.
Although it is a tabular file, for downstream processing we want to tell Galaxy that this is a *pileup* file.

From the drop-down, select Pileup and click save.

</code></pre>

<blockquote>
<p><img src="https://github.com/khalidm/Intro-variant-calling-galaxy/raw/master/media/tips.png" alt="Tip" height="42" width="42">
 Tip:
Get familiar with the <a href="https://www.google.com/url?q=https://docs.google.com/document/pub?id%3D1fouC29Lq0CXxQQCpuojrR5RXbdzMdxRf8ZID01XYNqI%23h.931a12a1a6ce&amp;sa=D&amp;usg=AFQjCNE-_ur_EqlMdu0A35ylXxlrNTlktA">Pileup</a> format.</p>

<ul>
<li>1. chromosome</li>
<li>2. position</li>
<li>3. current reference base</li>
<li>4. consensus base from the mapped reads</li>
<li>5. consensus quality</li>
<li>6. SNV quality</li>
<li>7. maximum mapping quality</li>
<li>8. coverage</li>
<li>9. bases within reads</li>
<li>10. quality values
Further on (9):

<ul>
<li>Each character represents one of the following: the longer this string, higher the coverage</li>
<li>. = match on forward strand for that base</li>
<li>, = match on reverse strand</li>
<li>ACGTN = mismatch on forward</li>
<li>acgtn = mismatch on reverse</li>
<li>+[0-9]+[ACGTNacgtn]+' = insertion between this reference position and the next</li>
<li>-[0-9]+[ACGTNacgtn]+' = deletion between this reference position and the next</li>
<li>^ = start of read</li>
<li>$ = end of read</li>
<li>BaseQualities = one character per base in ReadBases, ASCII encoded Phred scores</li>
</ul>
</li>
</ul>
</blockquote>
</li>
<li>
<p>Filtering pileup to get a list of SNVs</p>

<p>The pileup from the above steps described <em>all</em> aligned positions. For the purpose of calling SNVs, we are after:</p>

<ul>
<li>aligned positions where the consensus base is difference from the reference base</li>
<li>the different consensus base is covered by at least e.g. 10 reads<br>
</li>
<li>removing poor quality bases</li>
</ul>

<p>From the Galaxy tools panel, select</p>

<pre><code>NGS: SAM Tools &gt; Filter Pileup

From the options:
which contains = Pileup with ten columns (with consensus)
Do not report positions with coverage lower than = 10
Convert coordinates to intervals = Yes  

keep other options as default and click execute    
</code></pre>

<p>How many variants (<em>intervals</em>) do you see?</p>

<p>If you see ~17000 variants - do not be surprised. Our filtering criteria was not very stringent.</p>

<blockquote>
<p><img src="media/tips.png" alt="Tip" height="42" width="42">
Tip:
How many SNVs should we be expecting?
Generally you can expect 1 SNV per 1000 bases and the exome of chromosome 22 is about 6-700kb (~2% of the 33500kb length of chr22).
Therefore, we should expect to see ~700 SNVs.</p>
</blockquote>

<p>To further filter the dataset from above, we can use the <em>Filter and sort</em> tool.</p>

<p>From the Galaxy tools panel, select</p>

<pre><code>
Filter and Sort &gt; Filter

From the options:
With following condition = c7&gt;50 (filter on SNV quality (column 7)). This is a score generated by a combination of reads and base quality etc.

keep other options as default and click execute    

</code></pre>

<p>Note that the number of SNVs has gone down by ~95%, and we're down to 896, which is not too far off the expected number.</p>

<p>To visualize these variants we need to go back to IGV or any other genome browser of your choice.</p>

<blockquote>
<p><img src="https://github.com/khalidm/Intro-variant-calling-galaxy/raw/master/media/tips.png" alt="Tip" height="42" width="42">
 Tip:
Interval file description</p>

<ul>
<li>1. Chromosome</li>
<li>2. Start position (0-based)</li>
<li>3. End position (1-based)</li>
<li>4. Reference base at that position</li>
<li>5. Coverage (# reads aligning over that position)</li>
<li>6. Bases within reads</li>
<li>7. Quality values (phred33 scale, see Galaxy wiki for more)</li>
<li>8. Number of A variants</li>
<li>9. Number of C variants</li>
<li>10. Number of G variants</li>
<li>11. Number of T variants</li>
<li>12. Quality adjusted coverage</li>
<li>13. Total number of deviants (if Convert coordinates to intervals? is set to yes)</li>
</ul>
</blockquote>
</li>
<li>
<p>Convert the variants file to <a href="https://genome.ucsc.edu/FAQ/FAQformat.html#format1">BED</a> format.</p>

<ul>
<li>Start with renaming the variant file to e.g. 'NA12878.filtered.snps'</li>
<li>
<p>Change the filetype (under the pencil - see tips above) to bed.</p>

<blockquote>
<p>Bed files are similar to Interval files, but follow a stricter structural format</p>
</blockquote>
</li>
<li><p>Download the BED file by clicking on the disc icon and saving to local disk.</p></li>
<li>Assuming the alignment (bam file) is open, load the downloaded bed file.</li>
<li>Select <em>chr22</em> from the drop-down to see all SNVs.</li>
<li>The track - <em>NA12878.filtered.snps.bed</em> - now shows an zoomed out view of all SNVs.</li>
<li>
<p>Take a look again at the same region as earlier:</p>

<ul>
<li>chr22:36,006,744-36,007,406</li>
</ul>

<p><img src="https://github.com/khalidm/Intro-variant-calling-galaxy/raw/master/media/igv_snv.jpg" alt="IGV SNV view" width="640px"></p>

<blockquote>
<p>Is this a heterozygous variant?</p>
</blockquote>
</li>
<li>
<p>Now zoom into the region chr22:35,947,503-35,947,667.</p>

<blockquote>
<p>Is this a homozygous variant?</p>
</blockquote>
</li>
</ul>
</li>
</ol>

<h2>
<a id="7-calling-small-insertions-and-deletions-indels" class="anchor" href="#7-calling-small-insertions-and-deletions-indels" aria-hidden="true"><span class="octicon octicon-link"></span></a>7. Calling small insertions and deletions (indels)</h2>

<ol>
<li>
<p>Generate a pileup file from the aligned reads containing only indels.
From the Galaxy tools panel, select</p>

<pre><code>
NGS: SAM Tools &gt; Generate pileup

From the options:
Select the BAM file to generate the pileup file for = sorted bam file
Whether or not to print only output pileup lines containing indels = Print only lines containing indels
Call consensus according to MAQ model? = yes

Keep other options as default and click execute    

</code></pre>
</li>
<li>
<p>Filtering pileup to get a list of indels</p>

<p>Unlike the previous pileup, this file will only report putative indels. Like previously, we will need to filter the ~4000 indels down. Therefore, we will filter on:</p>

<ul>
<li>removing poor quality bases (column 7)</li>
<li>the indel is covered by at least e.g. 10 reads (column 11)</li>
</ul>

<p>From the Galaxy tools panel, select</p>

<pre><code>
Filter and Sort &gt; Filter

From the options:
With following condition =  c7&gt;50 and c11&gt;20

keep other options as default and click execute

</code></pre>

<p>This filtering strategy reduces the call set by 83% and we are left with <strong>~700 small indels</strong>.</p>

<p>To visualize, we need to convert from <em>tabular</em> to <em>interval</em>.</p>

<blockquote>
<p><img src="https://github.com/khalidm/Intro-variant-calling-galaxy/raw/master/media/tips.png" alt="Tip" height="42" width="42">
Tip:
Click the pencil icon. Click the Datatype tab and choose <em>Interval</em>.</p>
</blockquote>

<p>Next, we can convert the <em>Interval</em> file to <em>BED</em> format.</p>

<blockquote>
<p><img src="https://github.com/khalidm/Intro-variant-calling-galaxy/raw/master/media/tips.png" alt="Tip" height="42" width="42">
Tip:
Click the pencil icon again. Click the <em>Convert Format</em> tab and choose <em>Convert Genomic Interval to BED</em>.
Rename this to indels.filtered</p>
</blockquote>

<p>Download this file and open it using IGV genome browser.</p>

<pre><code>
Try looking at region chr22:31,854,409-31,854,460
Can you see any indels?
Also try looking at other regions by zooming out.  

</code></pre>

<p><img src="https://github.com/khalidm/Intro-variant-calling-galaxy/raw/master/media/igv_indel.jpg" alt="IGV indel" width="640px"></p>

<hr>
</li>
</ol>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/khalidm/Intro-variant-calling-galaxy">Introduction to Variant Calling using Galaxy</a> is maintained by <a href="https://github.com/khalidm">khalidm</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>
